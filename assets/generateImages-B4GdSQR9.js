import{g as ke}from"./index-mV8AnU2s.js";let B;const De=new Uint8Array(16);function ve(){if(!B&&(B=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!B))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return B(De)}const we=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function be(e){return typeof e=="string"&&we.test(e)}const E=[];for(let e=0;e<256;++e)E.push((e+256).toString(16).slice(1));function Te(e,s=0){return E[e[s+0]]+E[e[s+1]]+E[e[s+2]]+E[e[s+3]]+"-"+E[e[s+4]]+E[e[s+5]]+"-"+E[e[s+6]]+E[e[s+7]]+"-"+E[e[s+8]]+E[e[s+9]]+"-"+E[e[s+10]]+E[e[s+11]]+E[e[s+12]]+E[e[s+13]]+E[e[s+14]]+E[e[s+15]]}const Ee=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ne={randomUUID:Ee};function Re(e,s,a){if(ne.randomUUID&&!s&&!e)return ne.randomUUID();e=e||{};const l=e.random||(e.rng||ve)();return l[6]=l[6]&15|64,l[8]=l[8]&63|128,Te(l)}var Se=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")};const Pe=ke(Se);var xe=Object.create,ce=Object.defineProperty,Ae=Object.getOwnPropertyDescriptor,Me=Object.getOwnPropertyNames,Ce=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty,Le=(e,s)=>()=>(s||e((s={exports:{}}).exports,s),s.exports),Ne=(e,s,a,l)=>{if(s&&typeof s=="object"||typeof s=="function")for(let u of Me(s))!Oe.call(e,u)&&u!==a&&ce(e,u,{get:()=>s[u],enumerable:!(l=Ae(s,u))||l.enumerable});return e},Ke=(e,s,a)=>(a=e!=null?xe(Ce(e)):{},Ne(ce(a,"default",{value:e,enumerable:!0}),e)),Fe=Le((e,s)=>{var a=c=>c&&c.CLOSING===2,l=()=>typeof WebSocket<"u"&&a(WebSocket),u=()=>({constructor:l()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}),t=(c,m,p)=>{Object.defineProperty(m,p,{get:()=>c[p],set:o=>{c[p]=o},enumerable:!0,configurable:!0})},r=c=>c.minReconnectionDelay+Math.random()*c.minReconnectionDelay,i=(c,m)=>{let p=m*c.reconnectionDelayGrowFactor;return p>c.maxReconnectionDelay?c.maxReconnectionDelay:p},n=["onopen","onclose","onmessage","onerror"],h=(c,m,p)=>{Object.keys(p).forEach(o=>{p[o].forEach(([g,d])=>{c.addEventListener(o,g,d)})}),m&&n.forEach(o=>{c[o]=m[o]})},_=function(c,m,p={}){let o,g,d=0,D=0,k=!0,I={};if(!(this instanceof _))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");let U=u();if(Object.keys(U).filter(f=>p.hasOwnProperty(f)).forEach(f=>U[f]=p[f]),!a(U.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");let y=U.debug?(...f)=>console.log("RWS:",...f):()=>{},x=(f,v)=>setTimeout(()=>{let T=new Error(v);T.code=f,Array.isArray(I.error)&&I.error.forEach(([P])=>P(T)),o.onerror&&o.onerror(T)},0),R=()=>{if(y("close"),D++,y("retries count:",D),D>U.maxRetries){x("EHOSTDOWN","Too many failed connection attempts");return}d?d=i(U,d):d=r(U),y("reconnectDelay:",d),k&&setTimeout(b,d)},b=()=>{y("connect");let f=o;o=new U.constructor(c,m),g=setTimeout(()=>{y("timeout"),o.close(),x("ETIMEDOUT","Connection timeout")},U.connectionTimeout),y("bypass properties");for(let v in o)["addEventListener","removeEventListener","close","send"].indexOf(v)<0&&t(o,this,v);o.addEventListener("open",()=>{clearTimeout(g),y("open"),d=r(U),y("reconnectDelay:",d),D=0}),o.addEventListener("close",R),h(o,f,I)};y("init"),b(),this.close=(f=1e3,v="",{keepClosed:T=!1,fastClose:P=!0,delay:S=0}={})=>{if(S&&(d=S),k=!T,o.close(f,v),P){let L={code:f,reason:v,wasClean:!0};R(),Array.isArray(I.close)&&I.close.forEach(([F,j])=>{F(L),o.removeEventListener("close",F,j)}),o.onclose&&(o.onclose(L),o.onclose=null)}},this.send=f=>{o.send(f)},this.addEventListener=(f,v,T)=>{Array.isArray(I[f])?I[f].some(([P])=>P===v)||I[f].push([v,T]):I[f]=[[v,T]],o.addEventListener(f,v,T)},this.removeEventListener=(f,v,T)=>{Array.isArray(I[f])&&(I[f]=I[f].filter(([P])=>P!==v)),o.removeEventListener(f,v,T)}};s.exports=_}),Ge=(e=>(e.PRODUCTION="PRODUCTION",e.DEVELOPMENT="DEVELOPMENT",e.TEST="TEST",e))(Ge||{}),je=(e=>(e.CLIENT="CLIENT",e.SERVER="SERVER",e))(je||{}),We=(e=>(e.IMAGE_INFERENCE="imageInference",e.IMAGE_UPLOAD="imageUpload",e.IMAGE_UPSCALE="imageUpscale",e.IMAGE_BACKGROUND_REMOVAL="imageBackgroundRemoval",e.VIDEO_INFERENCE="videoInference",e.GET_RESPONSE="getResponse",e.PHOTO_MAKER="photoMaker",e.IMAGE_CAPTION="imageCaption",e.IMAGE_CONTROL_NET_PRE_PROCESS="imageControlNetPreProcess",e.IMAGE_MASKING="imageMasking",e.PROMPT_ENHANCE="promptEnhance",e.AUTHENTICATION="authentication",e.MODEL_UPLOAD="modelUpload",e.MODEL_SEARCH="modelSearch",e))(We||{}),Ve=(e=>(e.BALANCED="balanced",e.PROMPT="prompt",e.CONTROL_NET="controlnet",e))(Ve||{}),qe=(e=>(e.canny="canny",e.depth="depth",e.mlsd="mlsd",e.normalbae="normalbae",e.openpose="openpose",e.tile="tile",e.seg="seg",e.lineart="lineart",e.lineart_anime="lineart_anime",e.shuffle="shuffle",e.scribble="scribble",e.softedge="softedge",e))(qe||{}),Qe=(e=>(e.canny="canny",e.depth_leres="depth_leres",e.depth_midas="depth_midas",e.depth_zoe="depth_zoe",e.inpaint_global_harmonious="inpaint_global_harmonious",e.lineart_anime="lineart_anime",e.lineart_coarse="lineart_coarse",e.lineart_realistic="lineart_realistic",e.lineart_standard="lineart_standard",e.mlsd="mlsd",e.normal_bae="normal_bae",e.scribble_hed="scribble_hed",e.scribble_pidinet="scribble_pidinet",e.seg_ofade20k="seg_ofade20k",e.seg_ofcoco="seg_ofcoco",e.seg_ufade20k="seg_ufade20k",e.shuffle="shuffle",e.softedge_hed="softedge_hed",e.softedge_hedsafe="softedge_hedsafe",e.softedge_pidinet="softedge_pidinet",e.softedge_pidisafe="softedge_pidisafe",e.tile_gaussian="tile_gaussian",e.openpose="openpose",e.openpose_face="openpose_face",e.openpose_faceonly="openpose_faceonly",e.openpose_full="openpose_full",e.openpose_hand="openpose_hand",e))(Qe||{}),Be=(e=>(e.openpose="openpose",e.openpose_face="openpose_face",e.openpose_faceonly="openpose_faceonly",e.openpose_full="openpose_full",e.openpose_hand="openpose_hand",e))(Be||{}),He=(e=>(e.safetensors="safetensors",e.pickletensor="pickletensor",e))(He||{}),$e=(e=>(e.flux1d="flux1d",e.flux1s="flux1s",e.pony="pony",e.sdhyper="sdhyper",e.sd1x="sd1x",e.sd1xlcm="sd1xlcm",e.sd3="sd3",e.sdxl="sdxl",e.sdxllcm="sdxllcm",e.sdxldistilled="sdxldistilled",e.sdxlhyper="sdxlhyper",e.sdxllightning="sdxllightning",e.sdxlturbo="sdxlturbo",e))($e||{}),ze=(e=>(e.base="base",e.inpainting="inpainting",e.pix2pix="pix2pix",e))(ze||{}),Je=(e=>(e.canny="canny",e.depth="depth",e.qrcode="qrcode",e.hed="hed",e.scrible="scrible",e.openpose="openpose",e.seg="segmentation",e.openmlsd="openmlsd",e.softedge="softedge",e.normal="normal bae",e.shuffle="shuffle",e.pix2pix="pix2pix",e.inpaint="inpaint",e.lineart="line art",e.sketch="sketch",e.inpaintdepth="inpaint depth",e.tile="tile",e.outfit="outfit",e.blur="blur",e.gray="gray",e.lowquality="low quality",e))(Je||{}),Ye=(e=>(e.NoStyle="No style",e.Cinematic="Cinematic",e.DisneyCharacter="Disney Character",e.DigitalArt="Digital Art",e.Photographic="Photographic",e.FantasyArt="Fantasy art",e.Neonpunk="Neonpunk",e.Enhance="Enhance",e.ComicBook="Comic book",e.Lowpoly="Lowpoly",e.LineArt="Line art",e))(Ye||{}),ee=6e4,H=1e3,de=100,oe={PRODUCTION:"wss://ws-api.runware.ai/v1",TEST:"ws://localhost:8080"},Xe=(e,s)=>{if(e==null)return;let a=e.indexOf(s);a!==-1&&e.splice(a,1)},N=(e,{debugKey:s="debugKey",timeoutDuration:a=ee,shouldThrowError:l=!0,pollingInterval:u=de})=>(a=a<H?H:a,new Promise((t,r)=>{let i=setTimeout(()=>{n&&(clearInterval(n),l&&r(`Response could not be received from server for ${s}`)),clearTimeout(i)},a),n=setInterval(async()=>{e({resolve:t,reject:r,intervalId:n})&&(clearInterval(n),clearTimeout(i))},u)})),Ze=e=>new Promise(s=>{let a=new FileReader;a.readAsDataURL(e),a.onload=function(){s(a.result)}}),M=()=>Re(),le=e=>be(e),et=({key:e,data:s,useZero:a=!0,shouldReturnString:l=!1})=>e.split(/\.|\[/).map(u=>u.replace(/\]$/,"")).reduce((u,t)=>{let r=a?0:void 0,i=u==null?void 0:u[t];if(!i)return r;if(Array.isArray(i)&&/^\d+$/.test(t)){let n=parseInt(t,10);return n>=0&&n<i.length?u[t]=i[n]:u[t]??r}else return u[t]??r},s||{})??{},tt=(e,s=1e3)=>new Promise(a=>setTimeout(a,e*s)),st=(e,s)=>e.filter(a=>a.key!==s.key),w=({key:e,value:s})=>s||s===0||s===!1?{[e]:s}:{},at=(e,s)=>Math.floor(Math.random()*(s-e+1))+e,rt=()=>at(1,Number.MAX_SAFE_INTEGER),it=(e,{debugKey:s="debugKey",timeoutDuration:a=ee,shouldThrowError:l=!0,pollingInterval:u=de})=>(a=a<H?H:a,new Promise((t,r)=>{let i=setTimeout(()=>{n&&(clearInterval(n),l&&r(`Response could not be received from server for ${s}`)),clearTimeout(i)},a),n=setInterval(async()=>{try{await e({resolve:t,reject:r,intervalId:n})&&(clearInterval(n),clearTimeout(i))}catch(h){clearInterval(n),clearTimeout(i),r(h)}},u)})),nt=e=>typeof e=="string"&&(e.startsWith("http:")||e.startsWith("https:")),C=async(e,s={})=>{let{delayInSeconds:a=1,callback:l}=s,u=s.maxRetries??1;for(;u;)try{return await e()}catch(t){if(l==null||l(),t==null?void 0:t.error)throw t;if(u--,u>0)await tt(a),await C(e,{...s,maxRetries:u});else throw t}},ue=class{constructor({apiKey:e,url:s=oe.PRODUCTION,shouldReconnect:a=!0,globalMaxRetries:l=2,timeoutDuration:u=ee}){this._listeners=[],this._globalMessages={},this._globalImages=[],this.ensureConnectionUUID=null,this.isWebsocketReadyState=()=>{var t;return((t=this._ws)==null?void 0:t.readyState)===1},this.isInvalidAPIKey=()=>{var t,r;return((r=(t=this._connectionError)==null?void 0:t.error)==null?void 0:r.code)==="invalidApiKey"},this.send=t=>{this._ws.send(JSON.stringify([t]))},this.uploadImage=async t=>{try{return await C(async()=>{let r=M();if(typeof t=="string"&&le(t))return{imageURL:t,imageUUID:t,taskUUID:r,taskType:"imageUpload"};let i=typeof t=="string"?t:await Ze(t);return{imageURL:i,imageUUID:i,taskUUID:r,taskType:"imageUpload"}})}catch(r){throw r}},this.controlNetPreProcess=async({inputImage:t,preProcessorType:r,height:i,width:n,outputType:h,outputFormat:_,highThresholdCanny:c,lowThresholdCanny:m,includeHandsAndFaceOpenPose:p,includeCost:o,outputQuality:g,customTaskUUID:d,retry:D,includeGenerationTime:k,includePayload:I})=>{let U=D||this._globalMaxRetries,y,x=Date.now();try{return await C(async()=>{await this.ensureConnection();let R=await this.uploadImage(t);if(!(R!=null&&R.imageUUID))return null;let b=d||M(),f={inputImage:R.imageUUID,taskType:"imageControlNetPreProcess",taskUUID:b,preProcessorType:r,...w({key:"height",value:i}),...w({key:"width",value:n}),...w({key:"outputType",value:h}),...w({key:"outputFormat",value:_}),...w({key:"includeCost",value:o}),...w({key:"highThresholdCanny",value:c}),...w({key:"lowThresholdCanny",value:m}),...w({key:"includeHandsAndFaceOpenPose",value:p}),...g?{outputQuality:g}:{}};this.send({...f}),y=this.globalListener({taskUUID:b});let v=await N(({resolve:T,reject:P})=>{let S=this.getSingleMessage({taskUUID:b});if(S){if(S!=null&&S.error)return P(S),!0;if(S)return T(S),!0}},{debugKey:"unprocessed-image",timeoutDuration:this._timeoutDuration});return y.destroy(),this.insertAdditionalResponse({response:v,payload:I?f:void 0,startTime:k?x:void 0}),v},{maxRetries:U,callback:()=>{y==null||y.destroy()}})}catch(R){throw R}},this.requestImageToText=async({inputImage:t,includeCost:r,customTaskUUID:i,retry:n,includePayload:h,includeGenerationTime:_})=>{let c=n||this._globalMaxRetries,m,p=Date.now();try{return await C(async()=>{await this.ensureConnection();let o=t?await this.uploadImage(t):null,g=i||M(),d={taskUUID:g,taskType:"imageCaption",inputImage:o==null?void 0:o.imageUUID,...w({key:"includeCost",value:r})};this.send(d),m=this.globalListener({taskUUID:g});let D=await N(({resolve:k,reject:I})=>{let U=this.getSingleMessage({taskUUID:g});if(U){if(U!=null&&U.error)return I(U),!0;if(U)return delete this._globalMessages[g],k(U),!0}},{debugKey:"remove-image-background",timeoutDuration:this._timeoutDuration});return m.destroy(),this.insertAdditionalResponse({response:D,payload:h?d:void 0,startTime:_?p:void 0}),D},{maxRetries:c,callback:()=>{m==null||m.destroy()}})}catch(o){throw o}},this.removeImageBackground=async t=>this.baseSingleRequest({payload:{...t,taskType:"imageBackgroundRemoval"},debugKey:"remove-image-background"}),this.videoInference=async t=>{let{skipResponse:r,inputAudios:i,...n}=t;try{if(i!=null&&i.length){for(let p of i)if(!nt(p)&&!le(p))throw new Error(`Invalid audio source: "${p}". Only public URLs or media UUIDs are supported for audio.`)}let h=await this.baseSingleRequest({payload:{...n,...i!=null&&i.length?{inputAudios:i}:{},deliveryMethod:"async",taskType:"videoInference"},debugKey:"video-inference"});if(r)return h;let _=h==null?void 0:h.taskUUID,c=(t==null?void 0:t.numberResults)??1,m=new Map;return await it(async({resolve:p,reject:o})=>{try{let g=await this.getResponse({taskUUID:_});for(let d of g||[])d.videoUUID&&m.set(d.videoUUID,d);return m.size===c?(p(Array.from(m.values())),!0):!1}catch(g){return o(g),!0}},{debugKey:"async-response",pollingInterval:2*1e3,timeoutDuration:10*60*1e3}),Array.from(m.values())}catch(h){throw h}},this.getResponse=async t=>{let r=t.taskUUID;return this.baseSingleRequest({payload:{...t,customTaskUUID:r,taskType:"getResponse"},isMultiple:!0,debugKey:"async-results"})},this.upscaleGan=async({inputImage:t,upscaleFactor:r,outputType:i,outputFormat:n,includeCost:h,outputQuality:_,customTaskUUID:c,retry:m,includeGenerationTime:p,includePayload:o})=>{let g=m||this._globalMaxRetries,d,D=Date.now();try{return await C(async()=>{await this.ensureConnection();let k;k=await this.uploadImage(t);let I=c||M(),U={taskUUID:I,inputImage:k==null?void 0:k.imageUUID,taskType:"imageUpscale",upscaleFactor:r,...w({key:"includeCost",value:h}),...i?{outputType:i}:{},..._?{outputQuality:_}:{},...n?{outputFormat:n}:{}};this.send(U),d=this.globalListener({taskUUID:I});let y=await N(({resolve:x,reject:R})=>{let b=this.getSingleMessage({taskUUID:I});if(b){if(b!=null&&b.error)return R(b),!0;if(b)return delete this._globalMessages[I],x(b),!0}},{debugKey:"upscale-gan",timeoutDuration:this._timeoutDuration});return d.destroy(),this.insertAdditionalResponse({response:y,payload:o?U:void 0,startTime:p?D:void 0}),y},{maxRetries:g,callback:()=>{d==null||d.destroy()}})}catch(k){throw k}},this.enhancePrompt=async({prompt:t,promptMaxLength:r=380,promptVersions:i=1,includeCost:n,customTaskUUID:h,retry:_,includeGenerationTime:c,includePayload:m})=>{let p=_||this._globalMaxRetries,o,g=Date.now();try{return await C(async()=>{await this.ensureConnection();let d=h||M(),D={prompt:t,taskUUID:d,promptMaxLength:r,promptVersions:i,...w({key:"includeCost",value:n}),taskType:"promptEnhance"};this.send(D),o=this.globalListener({taskUUID:d});let k=await N(({resolve:I,reject:U})=>{let y=this._globalMessages[d];if(y!=null&&y.error)return U(y),!0;if((y==null?void 0:y.length)>=i)return delete this._globalMessages[d],I(y),!0},{debugKey:"enhance-prompt",timeoutDuration:this._timeoutDuration});return o.destroy(),this.insertAdditionalResponse({response:k,payload:m?D:void 0,startTime:c?g:void 0}),k},{maxRetries:p,callback:()=>{o==null||o.destroy()}})}catch(d){throw d}},this.modelUpload=async t=>{let{onUploadStream:r,retry:i,customTaskUUID:n,...h}=t,_=i||this._globalMaxRetries,c;try{return await C(async()=>{await this.ensureConnection();let m=n||M();this.send({...h,taskUUID:m,taskType:"modelUpload"});let p,o;return c=this.listenToUpload({taskUUID:m,onUploadStream:(g,d)=>{r==null||r(g,d),(g==null?void 0:g.status)==="ready"?p=g:d&&(o=d)}}),await N(({resolve:g,reject:d})=>{if(p)return g(p),!0;if(o)return d(o),!1},{shouldThrowError:!1,timeoutDuration:60*60*1e3})},{maxRetries:_,callback:()=>{c==null||c.destroy()}})}catch(m){throw m}},this.photoMaker=async(t,r)=>{let{onPartialImages:i,retry:n,customTaskUUID:h,numberResults:_,includeGenerationTime:c,includePayload:m,...p}=t,o=n||this._globalMaxRetries,g,d=[],D=0,k=Date.now();try{return await C(async()=>{await this.ensureConnection(),D++;let I=this._globalImages.filter(b=>d.includes(b.taskUUID)),U=h||M();d.push(U);let y=_-I.length,x={...p,...p.seed?{seed:p.seed}:{seed:rt()},...r??{},taskUUID:U,taskType:"photoMaker",numberResults:_};this.send({...x,numberResults:y}),g=this.listenToImages({onPartialImages:i,taskUUID:U,groupKey:"REQUEST_IMAGES",requestPayload:m?x:void 0,startTime:c?k:void 0});let R=await this.getSimilarImages({taskUUID:d,numberResults:_,lis:g});return g.destroy(),R},{maxRetries:o,callback:()=>{g==null||g.destroy()}})}catch(I){if(I.taskUUID)throw I;if(D>=o)return this.handleIncompleteImages({taskUUIDs:d,error:I})}},this.modelSearch=async t=>this.baseSingleRequest({payload:{...t,taskType:"modelSearch"},debugKey:"model-search"}),this.imageMasking=async t=>this.baseSingleRequest({payload:{...t,taskType:"imageMasking"},debugKey:"image-masking"}),this.imageUpload=async t=>this.baseSingleRequest({payload:{...t,taskType:"imageUpload"},debugKey:"image-upload"}),this.baseSingleRequest=async({payload:t,debugKey:r,isMultiple:i})=>{let{retry:n,customTaskUUID:h,includePayload:_,includeGenerationTime:c,...m}=t,p=n||this._globalMaxRetries,o,g=Date.now();try{return await C(async()=>{await this.ensureConnection();let d=h||M(),D={...m,taskUUID:d};this.send(D),o=this.globalListener({taskUUID:d});let k=await N(({resolve:I,reject:U})=>{let y=i?this.getMultipleMessages({taskUUID:d}):this.getSingleMessage({taskUUID:d});if(y){if(y!=null&&y.error)return U(y),!0;if(y)return delete this._globalMessages[d],I(y),!0}},{debugKey:r,timeoutDuration:this._timeoutDuration});return this.insertAdditionalResponse({response:k,payload:_?D:void 0,startTime:c?g:void 0}),o.destroy(),k},{maxRetries:p,callback:()=>{o==null||o.destroy()}})}catch(d){throw d}},this.getSingleMessage=({taskUUID:t})=>{var n;let r=(n=this._globalMessages[t])==null?void 0:n[0],i=this._globalMessages[t];return!r&&!i?null:i!=null&&i.error?i:r},this.getMultipleMessages=({taskUUID:t})=>{var n;let r=(n=this._globalMessages[t])==null?void 0:n[0],i=this._globalMessages[t];return!r&&!i?null:i},this.insertAdditionalResponse=({response:t,payload:r,startTime:i})=>{if(!r&&!i)return;let n=t;n.additionalResponse={},r&&(t.additionalResponse.payload=r),i&&(t.additionalResponse.generationTime=Date.now()-i)},this.disconnect=async()=>{var t,r,i,n;this._shouldReconnect=!1,(r=(t=this._ws)==null?void 0:t.terminate)==null||r.call(t),(n=(i=this._ws)==null?void 0:i.close)==null||n.call(i)},this.connected=()=>this.isWebsocketReadyState()&&!!this._connectionSessionUUID,this._apiKey=e,this._url=s,this._sdkType="CLIENT",this._shouldReconnect=a,this._globalMaxRetries=l,this._timeoutDuration=u}static async initialize(e){try{let s=new this(e);return await s.ensureConnection(),s}catch(s){throw s}}addListener({lis:e,groupKey:s,taskUUID:a}){let l=t=>{var h,_;let r=Array.isArray(t==null?void 0:t.data)?t.data:[t.data],i=(h=t==null?void 0:t[0])!=null&&h.errors?(_=t==null?void 0:t[0])==null?void 0:_.errors:Array.isArray(t==null?void 0:t.errors)?t.errors:[t.errors],n=r.filter(c=>((c==null?void 0:c.taskUUID)||(c==null?void 0:c.taskType))===a);if(i.filter(c=>((c==null?void 0:c.taskUUID)||(c==null?void 0:c.taskType))===a).length){e({error:{...i[0]??{}}});return}if(n.length){e({[a]:r});return}},u={key:a||M(),listener:l,groupKey:s};return this._listeners.push(u),{destroy:()=>{this._listeners=st(this._listeners,u)}}}connect(){this._ws.onopen=e=>{this._connectionSessionUUID?this.send({taskType:"authentication",apiKey:this._apiKey,connectionSessionUUID:this._connectionSessionUUID}):this.send({apiKey:this._apiKey,taskType:"authentication"}),this.addListener({taskUUID:"authentication",lis:s=>{var a,l;if(s!=null&&s.error){this._connectionError=s;return}this._connectionSessionUUID=(l=(a=s==null?void 0:s.authentication)==null?void 0:a[0])==null?void 0:l.connectionSessionUUID,this._connectionError=void 0}})},this._ws.onmessage=e=>{var a;let s=JSON.parse(e.data);for(let l of this._listeners)if((a=l==null?void 0:l.listener)!=null&&a.call(l,s))return},this._ws.onclose=e=>{this.isInvalidAPIKey()}}destroy(e){Xe(this._listeners,e)}listenToImages({onPartialImages:e,taskUUID:s,groupKey:a,requestPayload:l,startTime:u}){return this.addListener({taskUUID:s,lis:t=>{var i;let r=(i=t==null?void 0:t[s])==null?void 0:i.filter(n=>n.taskUUID===s);t.error?(e==null||e(r,(t==null?void 0:t.error)&&t),this._globalError=t):(r=r.map(n=>(this.insertAdditionalResponse({response:n,payload:l||void 0,startTime:u||void 0}),{...n})),e==null||e(r,(t==null?void 0:t.error)&&t),this._sdkType==="CLIENT"?this._globalImages=[...this._globalImages,...((t==null?void 0:t[s])??[]).map(n=>(this.insertAdditionalResponse({response:n,payload:l||void 0,startTime:u||void 0}),{...n}))]:this._globalImages=[...this._globalImages,...r])},groupKey:a})}listenToUpload({onUploadStream:e,taskUUID:s}){return this.addListener({taskUUID:s,lis:a=>{var r;let l=a==null?void 0:a.error,u=(r=a==null?void 0:a[s])==null?void 0:r[0],t=(u==null?void 0:u.taskUUID)===s?u:null;(t||l)&&(e==null||e(t||void 0,l))}})}globalListener({taskUUID:e}){return this.addListener({taskUUID:e,lis:s=>{if(s.error){this._globalMessages[e]=s;return}let a=et({key:e,data:s,useZero:!1});Array.isArray(a)?a.forEach(l=>{this._globalMessages[l.taskUUID]=[...this._globalMessages[l.taskUUID]??[],l]}):this._globalMessages[a.taskUUID]=a}})}async requestImages({outputType:e,outputFormat:s,uploadEndpoint:a,checkNSFW:l,positivePrompt:u,negativePrompt:t,seedImage:r,maskImage:i,strength:n,height:h,width:_,model:c,steps:m,scheduler:p,seed:o,CFGScale:g,clipSkip:d,usePromptWeighting:D,promptWeighting:k,numberResults:I=1,onPartialImages:U,includeCost:y,customTaskUUID:x,retry:R,refiner:b,maskMargin:f,outputQuality:v,controlNet:T,lora:P,embeddings:S,ipAdapters:L,providerSettings:F,outpaint:j,acceleratorOptions:te,advancedFeatures:se,referenceImages:W,includeGenerationTime:he,includePayload:pe,...ge},ye){let O,ae,V=[],re=0,ie=R||this._globalMaxRetries;try{await this.ensureConnection();let K=null,$=null,z=[];if(r){let A=await this.uploadImage(r);if(!A)return[];K=A.imageUUID}if(i){let A=await this.uploadImage(i);if(!A)return[];$=A.imageUUID}if(T!=null&&T.length)for(let A=0;A<T.length;A++){let G=T[A],{endStep:J,startStep:q,weight:Y,guideImage:Q,controlMode:Ie,startStepPercentage:Ue,endStepPercentage:_e,model:fe}=G,X=Q?await this.uploadImage(Q):null;z.push({guideImage:X==null?void 0:X.imageUUID,model:fe,endStep:J,startStep:q,weight:Y,...w({key:"startStepPercentage",value:Ue}),...w({key:"endStepPercentage",value:_e}),controlMode:Ie||"controlnet"})}ae={taskType:"imageInference",model:c,positivePrompt:u,...t?{negativePrompt:t}:{},...h?{height:h}:{},..._?{width:_}:{},numberResults:I,...e?{outputType:e}:{},...s?{outputFormat:s}:{},...a?{uploadEndpoint:a}:{},...w({key:"checkNSFW",value:l}),...w({key:"strength",value:n}),...w({key:"CFGScale",value:g}),...w({key:"clipSkip",value:d}),...w({key:"maskMargin",value:f}),...w({key:"usePromptWeighting",value:D}),...w({key:"steps",value:m}),...k?{promptWeighting:k}:{},...o?{seed:o}:{},...p?{scheduler:p}:{},...b?{refiner:b}:{},...j?{outpaint:j}:{},...w({key:"includeCost",value:y}),...K?{seedImage:K}:{},...$?{maskImage:$}:{},...v?{outputQuality:v}:{},...z.length?{controlNet:z}:{},...P!=null&&P.length?{lora:P}:{},...S!=null&&S.length?{embeddings:S}:{},...L!=null&&L.length?{ipAdapters:L}:{},...F?{providerSettings:F}:{},...te?{acceleratorOptions:te}:{},...se?{advancedFeatures:se}:{},...W!=null&&W.length?{referenceImages:W}:{},...ge,...ye??{}};let me=Date.now();return await C(async()=>{re++,O==null||O.destroy();let A=this._globalImages.filter(Q=>V.includes(Q.taskUUID)),G=x||M();V.push(G);let J=I-A.length,q={...ae,taskUUID:G,numberResults:J};this.send(q),O=this.listenToImages({onPartialImages:U,taskUUID:G,groupKey:"REQUEST_IMAGES",requestPayload:pe?q:void 0,startTime:he?me:void 0});let Y=await this.getSimilarImages({taskUUID:V,numberResults:I,lis:O});return O.destroy(),Y},{maxRetries:ie,callback:()=>{O==null||O.destroy()}})}catch(K){if(re>=ie)return this.handleIncompleteImages({taskUUIDs:V,error:K});throw K}}async ensureConnection(){if(this.connected()||this._url===oe.TEST)return;let e=2e3,s=200;try{if(this.isInvalidAPIKey())throw this._connectionError;return new Promise((a,l)=>{let u=0,t=30,r=M(),i,n,h=()=>{this.ensureConnectionUUID=null,clearInterval(i),clearInterval(n)};this._sdkType==="SERVER"&&(i=setInterval(async()=>{try{let _=this.connected(),c=!1;(!this.ensureConnectionUUID||r===this.ensureConnectionUUID)&&(this.ensureConnectionUUID||(this.ensureConnectionUUID=r),c=!0);let m=u%10===0&&c;_?(h(),a(!0)):u>=t?(h(),l(new Error("Retry timed out"))):(m&&this.connect(),u++)}catch(_){h(),l(_)}},e)),n=setInterval(async()=>{if(this.connected()){h(),a(!0);return}if(this.isInvalidAPIKey()){h(),l(this._connectionError);return}},s)})}catch{throw this.ensureConnectionUUID=null,this._connectionError=void 0,this._connectionError??"Could not connect to server. Ensure your API key is correct"}}async getSimilarImages({taskUUID:e,numberResults:s,shouldThrowError:a,lis:l}){return await N(({resolve:u,reject:t,intervalId:r})=>{let i=Array.isArray(e)?e:[e],n=this._globalImages.filter(h=>i.includes(h.taskUUID));if(this._globalError){let h=this._globalError;return this._globalError=void 0,clearInterval(r),t==null||t(h),!0}else if(n.length>=s)return clearInterval(r),this._globalImages=this._globalImages.filter(h=>!i.includes(h.taskUUID)),u([...n].slice(0,s)),!0},{debugKey:"getting images",shouldThrowError:a,timeoutDuration:this._timeoutDuration})}handleIncompleteImages({taskUUIDs:e,error:s}){let a=this._globalImages.filter(l=>e.includes(l.taskUUID));if(a.length>1)return this._globalImages=this._globalImages.filter(l=>!e.includes(l.taskUUID)),a;throw s}},ot=Ke(Fe()),lt=class extends ue{constructor(e){let{shouldReconnect:s,...a}=e;super(a),this._ws=new ot.default(this._url),this.connect()}},ct=class extends ue{constructor(e){super(e),this._instantiated=!1,this._listeners=[],this._reconnectingIntervalId=null,this.send=s=>{this._ws.send(JSON.stringify([s]))},this.resetConnection=()=>{this._ws&&(this._listeners.forEach(s=>{var a;(a=s==null?void 0:s.destroy)==null||a.call(s)}),this._ws.removeAllListeners(),this._ws.readyState===1&&(this._ws.terminate(),this._ws.close()),this._ws=null,this._listeners=[])},this._sdkType="SERVER",this.connect()}async connect(){this._url&&(this.resetConnection(),this._ws=new Pe(this._url,{perMessageDeflate:!1}),this._ws.on("error",()=>{}),this._ws.on("close",()=>{this.handleClose()}),this._ws.on("open",()=>{this._reconnectingIntervalId&&clearInterval(this._reconnectingIntervalId),this._connectionSessionUUID&&this.isWebsocketReadyState()?this.send({taskType:"authentication",apiKey:this._apiKey,connectionSessionUUID:this._connectionSessionUUID}):this.isWebsocketReadyState()&&this.send({apiKey:this._apiKey,taskType:"authentication"}),this.addListener({taskUUID:"authentication",lis:e=>{var s,a;if(e!=null&&e.error){this._connectionError=e;return}this._connectionSessionUUID=(a=(s=e==null?void 0:e.authentication)==null?void 0:s[0])==null?void 0:a.connectionSessionUUID,this._connectionError=void 0}})}),this._ws.on("message",(e,s)=>{let a=s?e:e==null?void 0:e.toString();if(!a)return;let l=JSON.parse(a);this._listeners.forEach(u=>{u.listener(l)})}))}handleClose(){this.isInvalidAPIKey()||(this._reconnectingIntervalId&&clearInterval(this._reconnectingIntervalId),this._shouldReconnect&&setTimeout(()=>this.connect(),1e3))}heartBeat(){clearTimeout(this._pingTimeout),this._pingTimeout=setTimeout(()=>{this.isWebsocketReadyState()&&this.send({ping:!0})},5e3)}},Z;typeof window>"u"?Z=ct:Z=lt;const dt=new Z({apiKey:"dgk5rP5fNTfVAEvjixKFRCTKB4dTc8XP"});async function ht(e){try{const[s]=await dt.requestImages({positivePrompt:e,width:320,height:320,numberResults:1,model:"civitai:102438@133677"});return s.imageURL}catch(s){throw console.error("Error generating image:",s),new Error("Failed to generate image")}}export{ht as generateFromText};
